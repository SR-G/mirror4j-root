# Mirror4J

**Mirror4J** is a Java implementation for the mir:ror RFID reader (produced by Violet, USB device).

* Allows to react to RFID Ztamps dropped on the mir:ror USB device.

* Fully multi-threaded

* External configuration

* Easy to set up

![mir:ror](https://github.com/SR-G/mirror4j/raw/master/violet_rfid_mirror.jpg)

## Available actions 

Actions are either included in the mirror4j distribution or available as additionnal plugins that have just to be dropped in the lib/ folder :

* (included in mirror4j) Shell Execution

* (included in mirror4j) HTTP Execution

* (included in mirror4j) Java Class Execution (executes any java class available on the classpath)

* [SSH Execution](https://github.com/SR-G/mirror4j-plugin-ssh)

* [SSH Execution](https://github.com/SR-G/mirror4j-plugin-jsch) (through jsch)

* [Sonos Execution](https://github.com/SR-G/mirror4j-plugin-sonos) (starts, stops, mute, ... sonos audio boxes)

* [XPL Execution](https://github.com/SR-G/mirror4j-plugin-xpl) (sends an event on the xPL bus)

* [Wake On Lan Execution](https://github.com/SR-G/mirror4j-plugin-wake-on-lan) (wakes up a remote host through wol - may be used to make Sleep On Lan, see TODO(serge) add link)

# How to run this

## Hardware 

A good solution is to run this on a raspberry pi computer (model B for me), with ARM processor. 512mo is plenty enough. On the new raspberry pi revision (the model B with 512 RAM), the USB ports work now fine and are able to handle without any problem the Mir:ror USB device directly, without any USB hub (previous revisions of the PI weren't able to deliver enough power through the USB ports and the mir:ror device's behavior was quite weird). Works even better with Raspberry B+.

Another working hardware are the Solid Run Cubox-i* mini-computers : [www.solid-run.com](http://www.solid-run.com/products/cubox-i-mini-computer/) (i have a Cubox-i2Ultra on my side) (ARM v6/v7, SoftABI). 

## Java

On ARM platforms, it is adviced to use the Oracle JRE distribution and not the OpenJDK one in order to have the best performance.

## Start the program

Take the full distribution set here : TODO(serge) add link

Update the mirror4j.xml configuration file.

Start the program with the provided shell (provided in the distribution zip or available as source in [src/script/mirror4j.sh](https://github.com/SR-G/mirror4j/blob/master/src/script/mirror4j.sh) 

# Mirror4J Usage

<pre>
<!-- BEGIN_AUTOGENERATED_CONTENT_USAGE -->
Usage: <main class> [options]
  Options:
    --configuration, -c
       Configuration file name to load. If not provided, a file named
       "mirror4j.xml" on the current path will be used
       Default: mirror4j.xml
        --debug
       Debug mode
       Default: false
    --device, -d
       Device name to use, e.g., /dev/hidraw0. If not provided, the first
       /dev/hidraw will be used
        --pid
       The PID filename. Default is current directory, file mirror4j.pid
       Default: mirror4j.pid
        --reconnection-timeout
       When expected device is not found (or was found previously but not
       anymore), we'll wait this timeout before trying to reconnect. In milliseconds.
       Default 2000.
       Default: 2000
    -h, --usage, --help
       Shows available commands
       Default: false

<!-- END_AUTOGENERATED_CONTENT_USAGE -->
</pre>

# Mirror4J Configuration

<!-- BEGIN_AUTOGENERATED_CONTENT_PREFERENCES -->
## 1. Mirror<a name="1._Mirror"></a>

Global mirror4j configuration

### Attributes

<table>
  <tr>
    <th><b>Attributes</b></th>
    <th><b>Type</b></th>
    <th><b>Required</b></th>
    <th><b>Description</b></th>
  </tr>
  <tr>
    <td>purge-on-start</td>
    <td>boolean</td>
    <td>   </td>
    <td>(@TODO) Description de purgeOnStart</td>
  </tr>
</table>


### Elements

<table>
  <tr>
    <th><b>Elements</b></th>
    <th><b>Type</b></th>
    <th><b>Required</b></th>
    <th><b>Description</b></th>
  </tr>
  <tr>
    <td>List of <a href="#2._Ztamp">ztamp</a></td>
    <td><a href="#2._Ztamp">ztamp</a></td>
    <td>   </td>
    <td>Configuration of the various ztamp to define</td>
  </tr>
  <tr>
    <td>List of <a href="#3._Device">device</a></td>
    <td><a href="#3._Device">device</a></td>
    <td>   </td>
    <td>Configuration of the mir:ror device itself</td>
  </tr>
  <tr>
    <td>definitions</td>
    <td>IDefinition</td>
    <td>   </td>
    <td>(@TODO) Description de definitions</td>
  </tr>
</table>


### Example

<pre>
&lt;mirror purge-on-start='...'&gt;
   &lt;!-- List of 'ztamp' --&gt;
   &lt;ztamp&gt;
   . . .
   &lt;/ztamp&gt;
   .
   .
   .
   &lt;ztamp&gt;
   . . .
   &lt;/ztamp&gt;

   &lt;!-- List of 'device' --&gt;
   &lt;device&gt;
   . . .
   &lt;/device&gt;
   .
   .
   .
   &lt;device&gt;
   . . .
   &lt;/device&gt;

   &lt;!-- Description de 'definitions' --&gt;
   &lt;definitions&gt;
   . . .
   &lt;/definitions&gt;
&lt;/mirror&gt;
</pre>

### Implementation

<table>
  <tr>
    <td>Package</td>
    <td>org.tensin.mirror4j.model.configuration</td>
  </tr>
  <tr>
    <td>Class</td>
    <td>Mirror4JConfiguration</td>
  </tr>
</table>



## 2. Ztamp<a name="2._Ztamp"></a>

Configuration of a ztamp rfid

### Attributes

<table>
  <tr>
    <th><b>Attributes</b></th>
    <th><b>Type</b></th>
    <th><b>Required</b></th>
    <th><b>Description</b></th>
  </tr>
  <tr>
    <td>state</td>
    <td>String</td>
    <td> X </td>
    <td>The ztamp state on which to react (POSE, RETIRE, ENVERS, ...)</td>
  </tr>
  <tr>
    <td>id</td>
    <td>String</td>
    <td> X </td>
    <td>The ztamp id on which the given operations will be executed</td>
  </tr>
  <tr>
    <td>description</td>
    <td>String</td>
    <td>   </td>
    <td>Optionnal description to ease log reading</td>
  </tr>
  <tr>
    <td>active</td>
    <td>boolean</td>
    <td>   </td>
    <td>If this ztamp is active or not</td>
  </tr>
</table>


### Elements

<table>
  <tr>
    <th><b>Elements</b></th>
    <th><b>Type</b></th>
    <th><b>Required</b></th>
    <th><b>Description</b></th>
  </tr>
  <tr>
    <td>operations</td>
    <td>IOperation</td>
    <td>   </td>
    <td>The list of operations to run when the condition - id and state for example - are met</td>
  </tr>
</table>


### Example

<pre>
&lt;ztamp state='...' id='...' description='...' active='true|false'&gt;
   &lt;!-- Description de 'operations' --&gt;
   &lt;operations&gt;
   . . .
   &lt;/operations&gt;
&lt;/ztamp&gt;
</pre>

### Implementation

<table>
  <tr>
    <td>Package</td>
    <td>org.tensin.mirror4j.model.configuration</td>
  </tr>
  <tr>
    <td>Class</td>
    <td>ZtampConfiguration</td>
  </tr>
</table>



## 3. Device<a name="3._Device"></a>

Configuration of a mir:ror device

### Attributes

<table>
  <tr>
    <th><b>Attributes</b></th>
    <th><b>Type</b></th>
    <th><b>Required</b></th>
    <th><b>Description</b></th>
  </tr>
  <tr>
    <td>state</td>
    <td>String</td>
    <td> X </td>
    <td>The ztamp state on which to react (POSE, RETIRE, ENVERS, ...)</td>
  </tr>
</table>


### Elements

<table>
  <tr>
    <th><b>Elements</b></th>
    <th><b>Type</b></th>
    <th><b>Required</b></th>
    <th><b>Description</b></th>
  </tr>
  <tr>
    <td>operations</td>
    <td>IOperation</td>
    <td>   </td>
    <td>The list of operations to run when the condition - id and state for example - are met</td>
  </tr>
</table>


### Example

<pre>
&lt;device state='...'&gt;
   &lt;!-- Description de 'operations' --&gt;
   &lt;operations&gt;
   . . .
   &lt;/operations&gt;
&lt;/device&gt;
</pre>

### Implementation

<table>
  <tr>
    <td>Package</td>
    <td>org.tensin.mirror4j.model.configuration</td>
  </tr>
  <tr>
    <td>Class</td>
    <td>DeviceConfiguration</td>
  </tr>
</table>

<!-- END_AUTOGENERATED_CONTENT_PREFERENCES -->
# Mirror4J Operations Configuration
<!-- BEGIN_AUTOGENERATED_CONTENT_OPERATIONS -->
## 4. Http<a name="4._Http"></a>

Activate a given url

### Attributes

<table>
  <tr>
    <th><b>Attributes</b></th>
    <th><b>Type</b></th>
    <th><b>Required</b></th>
    <th><b>Description</b></th>
  </tr>
  <tr>
    <td>name</td>
    <td>String</td>
    <td>   </td>
    <td>Optional logical name of the operation to run</td>
  </tr>
  <tr>
    <td>active</td>
    <td>boolean</td>
    <td>   </td>
    <td>Optional description of the operation to run</td>
  </tr>
  <tr>
    <td>url</td>
    <td>String</td>
    <td> X </td>
    <td>The url to activate</td>
  </tr>
</table>


### Example

<pre>
&lt;http name='...' active='...' url='http://domotique.myhome.com/' /&gt;
</pre>

### Implementation

<table>
  <tr>
    <td>Package</td>
    <td>org.tensin.mirror4j.model.operations</td>
  </tr>
  <tr>
    <td>Class</td>
    <td>HTTPExecution</td>
  </tr>
</table>
## 5. Java<a name="5._Java"></a>

Java execution : executes any java class available in the classpath

### Attributes

<table>
  <tr>
    <th><b>Attributes</b></th>
    <th><b>Type</b></th>
    <th><b>Required</b></th>
    <th><b>Description</b></th>
  </tr>
  <tr>
    <td>name</td>
    <td>String</td>
    <td>   </td>
    <td>Optional logical name of the operation to run</td>
  </tr>
  <tr>
    <td>active</td>
    <td>boolean</td>
    <td>   </td>
    <td>Optional description of the operation to run</td>
  </tr>
  <tr>
    <td>javaOperationClass</td>
    <td>String</td>
    <td> X </td>
    <td>The java class to launch (must be available on the inital classpath of the mirror4j process)</td>
  </tr>
  <tr>
    <td>javaOperationMethod</td>
    <td>String</td>
    <td> X </td>
    <td>The java method name to run</td>
  </tr>
</table>


### Example

<pre>
&lt;java name='...' active='...' javaOperationClass='...'
         javaOperationMethod='...' /&gt;
</pre>

### Implementation

<table>
  <tr>
    <td>Package</td>
    <td>org.tensin.mirror4j.model.operations</td>
  </tr>
  <tr>
    <td>Class</td>
    <td>JavaExternalClassExecution</td>
  </tr>
</table>
## 6. Mqtt<a name="6._Mqtt"></a>

MQTT Execution : sends MQTT packets

### Attributes

<table>
  <tr>
    <th><b>Attributes</b></th>
    <th><b>Type</b></th>
    <th><b>Required</b></th>
    <th><b>Description</b></th>
  </tr>
  <tr>
    <td>name</td>
    <td>String</td>
    <td>   </td>
    <td>Optional logical name of the operation to run</td>
  </tr>
  <tr>
    <td>active</td>
    <td>boolean</td>
    <td>   </td>
    <td>Optional description of the operation to run</td>
  </tr>
  <tr>
    <td>pattern</td>
    <td>String</td>
    <td>   </td>
    <td>The pattern of the string that will be sent to the topic. Ex. ${device-id}|${device-state}</td>
  </tr>
  <tr>
    <td>broker-topic</td>
    <td>String</td>
    <td> X </td>
    <td>(@TODO) Description de brokerTopic</td>
  </tr>
  <tr>
    <td>destination</td>
    <td>String</td>
    <td>   </td>
    <td>Optionnal destination, if several brokers are defined. If alias is not set, the first defined broker is taken.</td>
  </tr>
</table>


### Example

<pre>
&lt;mqtt name='...' active='...' pattern='...' broker-topic='...'
         destination='...' /&gt;
</pre>

### Implementation

<table>
  <tr>
    <td>Package</td>
    <td>org.tensin.mirror4j.plugins.mqtt</td>
  </tr>
  <tr>
    <td>Class</td>
    <td>MQTTExecution</td>
  </tr>
</table>
## 7. Ssh<a name="7._Ssh"></a>

SSH Execution : execute a remote shell command through ssh. Only available with the plugin mirror4j-plugin-jsch

### Attributes

<table>
  <tr>
    <th><b>Attributes</b></th>
    <th><b>Type</b></th>
    <th><b>Required</b></th>
    <th><b>Description</b></th>
  </tr>
  <tr>
    <td>name</td>
    <td>String</td>
    <td>   </td>
    <td>Optional logical name of the operation to run</td>
  </tr>
  <tr>
    <td>active</td>
    <td>boolean</td>
    <td>   </td>
    <td>Optional description of the operation to run</td>
  </tr>
  <tr>
    <td>hostname</td>
    <td>String</td>
    <td> X </td>
    <td>The remote hostname to use</td>
  </tr>
  <tr>
    <td>username</td>
    <td>String</td>
    <td> X </td>
    <td>The remote username to connect with</td>
  </tr>
  <tr>
    <td>password</td>
    <td>String</td>
    <td>   </td>
    <td>The remote password to use (optional - only in case you don't have put ssh keys)</td>
  </tr>
  <tr>
    <td>command</td>
    <td>String</td>
    <td> X </td>
    <td>The remote command to run</td>
  </tr>
</table>


### Example

<pre>
&lt;ssh name='...' active='...' hostname='...' username='...' password='...'
        command='...' /&gt;
</pre>

### Implementation

<table>
  <tr>
    <td>Package</td>
    <td>org.tensin.mirror4j.plugins.ssh</td>
  </tr>
  <tr>
    <td>Class</td>
    <td>SSHExecution</td>
  </tr>
</table>
## 8. Shell<a name="8._Shell"></a>

Shell execution : executes any local shell script

### Attributes

<table>
  <tr>
    <th><b>Attributes</b></th>
    <th><b>Type</b></th>
    <th><b>Required</b></th>
    <th><b>Description</b></th>
  </tr>
  <tr>
    <td>name</td>
    <td>String</td>
    <td>   </td>
    <td>Optional logical name of the operation to run</td>
  </tr>
  <tr>
    <td>active</td>
    <td>boolean</td>
    <td>   </td>
    <td>Optional description of the operation to run</td>
  </tr>
  <tr>
    <td>command</td>
    <td>String</td>
    <td> X </td>
    <td>The shell command to run. /bin/bash will be used as interpreter.</td>
  </tr>
</table>


### Example

<pre>
&lt;shell name='...' active='...' command='...' /&gt;
</pre>

### Implementation

<table>
  <tr>
    <td>Package</td>
    <td>org.tensin.mirror4j.model.operations</td>
  </tr>
  <tr>
    <td>Class</td>
    <td>ShellExecution</td>
  </tr>
</table>
## 9. Sleep-on-lan<a name="9._Sleep-on-lan"></a>

SleepOnLanExecution : sleeps a remote host, by sending a reversed MAC address (strictly equivalent to using the 'wakeonlan' operation with a mac address manually reversed in configuration). You needs a SleepOnLan daemon (java or go implementation) to catch those packets and react upon them.

### Attributes

<table>
  <tr>
    <th><b>Attributes</b></th>
    <th><b>Type</b></th>
    <th><b>Required</b></th>
    <th><b>Description</b></th>
  </tr>
  <tr>
    <td>name</td>
    <td>String</td>
    <td>   </td>
    <td>Optional logical name of the operation to run</td>
  </tr>
  <tr>
    <td>active</td>
    <td>boolean</td>
    <td>   </td>
    <td>Optional description of the operation to run</td>
  </tr>
  <tr>
    <td>broadcast</td>
    <td>String</td>
    <td>   </td>
    <td>The broadcast IP to use. Default to 192.168.255.255</td>
  </tr>
  <tr>
    <td>mac</td>
    <td>String</td>
    <td> X </td>
    <td>The mac address to awake. Valid examples are : 00:0D:61:08:22:4A, 00-0D-61-08-22-4A. One mac address per operation.</td>
  </tr>
  <tr>
    <td>port</td>
    <td>int</td>
    <td>   </td>
    <td>(@TODO) Description de port</td>
  </tr>
</table>


### Example

<pre>
&lt;sleep-on-lan name='...' active='...' broadcast='...' mac='...' port='...' /&gt;
</pre>

### Implementation

<table>
  <tr>
    <td>Package</td>
    <td>org.tensin.mirror4j.plugins.wakeonlan</td>
  </tr>
  <tr>
    <td>Class</td>
    <td>SleepOnLanExecution</td>
  </tr>
</table>
## 10. Sonos<a name="10._Sonos"></a>

Sonos operation : executes a command (like play, stop, mute, ...) on one or several or all sonos boxes. Only available with the plugin mirror4j-plugin-sonos

### Attributes

<table>
  <tr>
    <th><b>Attributes</b></th>
    <th><b>Type</b></th>
    <th><b>Required</b></th>
    <th><b>Description</b></th>
  </tr>
  <tr>
    <td>name</td>
    <td>String</td>
    <td>   </td>
    <td>Optional logical name of the operation to run</td>
  </tr>
  <tr>
    <td>active</td>
    <td>boolean</td>
    <td>   </td>
    <td>Optional description of the operation to run</td>
  </tr>
  <tr>
    <td>zones</td>
    <td>String</td>
    <td> X </td>
    <td>The zones to act on. You can put one value like 'kitchen' or several ones like 'kitchen,room1' or the 'ALL' keyword</td>
  </tr>
  <tr>
    <td>action</td>
    <td>String</td>
    <td> X </td>
    <td>The action to use. Check Sonos documentation http://github.com/SR-G/sonos-java</td>
  </tr>
</table>


### Example

<pre>
&lt;sonos name='...' active='...' zones='kitchen,room1'
          action='Something like 'play', 'mute', 'removeall', 'next', 'prev' or 'stop' for example' /&gt;
</pre>

### Implementation

<table>
  <tr>
    <td>Package</td>
    <td>org.tensin.mirror4j.plugins.sonos</td>
  </tr>
  <tr>
    <td>Class</td>
    <td>SonosOperation</td>
  </tr>
</table>
## 11. Wake-on-lan<a name="11._Wake-on-lan"></a>

WakeOnLanExecution : wake a remote host

### Attributes

<table>
  <tr>
    <th><b>Attributes</b></th>
    <th><b>Type</b></th>
    <th><b>Required</b></th>
    <th><b>Description</b></th>
  </tr>
  <tr>
    <td>name</td>
    <td>String</td>
    <td>   </td>
    <td>Optional logical name of the operation to run</td>
  </tr>
  <tr>
    <td>active</td>
    <td>boolean</td>
    <td>   </td>
    <td>Optional description of the operation to run</td>
  </tr>
  <tr>
    <td>broadcast</td>
    <td>String</td>
    <td>   </td>
    <td>The broadcast IP to use. Default to 192.168.255.255</td>
  </tr>
  <tr>
    <td>mac</td>
    <td>String</td>
    <td> X </td>
    <td>The mac address to awake. Valid examples are : 00:0D:61:08:22:4A, 00-0D-61-08-22-4A. One mac address per operation.</td>
  </tr>
  <tr>
    <td>port</td>
    <td>int</td>
    <td>   </td>
    <td>(@TODO) Description de port</td>
  </tr>
</table>


### Example

<pre>
&lt;wake-on-lan name='...' active='...' broadcast='...' mac='...' port='...' /&gt;
</pre>

### Implementation

<table>
  <tr>
    <td>Package</td>
    <td>org.tensin.mirror4j.plugins.wakeonlan</td>
  </tr>
  <tr>
    <td>Class</td>
    <td>WakeOnLanExecution</td>
  </tr>
</table>
## 12. Xpl<a name="12._Xpl"></a>

Notify the event (either device or ztamp event) on the local xPL bus. Only available with the plugin mirror4j-plugin-xpl

### Attributes

<table>
  <tr>
    <th><b>Attributes</b></th>
    <th><b>Type</b></th>
    <th><b>Required</b></th>
    <th><b>Description</b></th>
  </tr>
  <tr>
    <td>name</td>
    <td>String</td>
    <td>   </td>
    <td>Optional logical name of the operation to run</td>
  </tr>
  <tr>
    <td>active</td>
    <td>boolean</td>
    <td>   </td>
    <td>Optional description of the operation to run</td>
  </tr>
  <tr>
    <td>mirror4jDeviceId</td>
    <td>String</td>
    <td>   </td>
    <td>The mirror4j device id</td>
  </tr>
  <tr>
    <td>mirror4jInstanceId</td>
    <td>String</td>
    <td>   </td>
    <td>The mirror4j instance id</td>
  </tr>
  <tr>
    <td>mirror4jVendorId</td>
    <td>String</td>
    <td>   </td>
    <td>The mirror4j vendor id</td>
  </tr>
  <tr>
    <td>mirror4jXPLSchemaType</td>
    <td>String</td>
    <td>   </td>
    <td>The xpl schema type to use in the sent xpl messages</td>
  </tr>
  <tr>
    <td>mirror4jXPLSchemaClass</td>
    <td>String</td>
    <td>   </td>
    <td>The xpl schema class to use in the sent xpl messages</td>
  </tr>
</table>


### Example

<pre>
&lt;xpl name='...' active='...' mirror4jDeviceId='mir:ror'
        mirror4jInstanceId='00000001' mirror4jVendorId='violet'
        mirror4jXPLSchemaType='event' mirror4jXPLSchemaClass='mirror4j' /&gt;
</pre>

### Implementation

<table>
  <tr>
    <td>Package</td>
    <td>org.tensin.mirror4j.plugins.xpl</td>
  </tr>
  <tr>
    <td>Class</td>
    <td>XPLExecution</td>
  </tr>
</table>

<!-- END_AUTOGENERATED_CONTENT_OPERATIONS -->

## TODO

* Finalize the configuration part

* Use a real Java USB library instead of reading /dev/hidraw*

